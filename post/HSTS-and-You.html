<!doctype html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>HTTP Strict-Transport-Security and You | Arcturus Labs</title><link rel=stylesheet href=/assets/normalise.css><link rel=stylesheet href=/assets/style.css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><main><header><h1>Arcturus Labs</h1><div class=header-links><a href=/><h2 class=header-link>Home</h2></a><a href=/archive.html><h2 class=header-link>Archive</h2></a><a href=/about.html><h2 class=header-link>About</h2></a></div></header><section id=main_content><article><aside class=articleheading><h1>HTTP Strict-Transport-Security and You</h1><h3>Posted by <a href=mailto:luke@arcturus.net>Luke R</a> on Tuesday, May 19 2020</h3></aside><h2 id=secure-connections-how-do-they-work>Secure Connections. How Do They Work?</h2><p>Modern browsers play a big part in web application security. They are responsible for establishing a secure connection with the web application, managing and verifying SSL certificates, warning users of potential security issues and securely storing session tokens. This represents a large attack surface, wherein many things can go wrong. This is one of the reasons why most browsers run in a security sandbox, which can help limit the impact of security vulnerabilities. But that’s another article.<p>One downside to these security controls is that many of them must be manually set by an application (or web server). Some via HTTP response headers, others via specific Cookie flags. Unfortunately, this means that many developers who aren’t security-conscious simply don’t know about them. Not knowing about the controls means they won’t implement them, leaving their users unprotected. This is <em>Bad™</em>.<p>In this article we’ll take a brief look at two specific security controls and how they work together. In case you hadn’t guessed, we will be looking at the <code class=highlighter-rouge>Strict-Transport-Security</code> HTTP header and the <code class=highlighter-rouge>Secure</code> Cookie flag.<h2 id=strict-transport-security>Strict-Transport-Security</h2><p>The HTTP Strict-Transport-Security response header (HSTS) is an HTTP response header which tells the user’s browser to perform all subsequent requests to a site using HTTPS instead of HTTP. This means that the browser will not send any data to an unsecured version of the site, until the <code class=highlighter-rouge>Strict-Transport-Security</code> header expires.<h2 id=secure-cookie-flag>Secure Cookie Flag</h2><p>The Secure flag is an option which can be set on cookies when they are issued by a website. This flag ensures that the cookie in question is only ever sent when it has been encrypted, such as when using HTTPS.<p>Do you see where we’re going yet?<h2 id=holy-union>Holy Union</h2><p>Now. Lacking either one of these security controls individually isn’t <em>TOO</em> serious of an issue. However, if neither of them are set, then problems can arise.<p>On an unsecured or shared connection (<em>such as a coffee shop, London Underground WiFi, etc</em>) bad guys who can intercept network traffic may be able to capture information exposed in the first unencrypted request to an HTTP URL.<p>When you type in onlyfans.com, your browser will send an HTTP request to ‘onlyfans.com’ – which will then <em>redirect</em> you to ‘https://onlyfans.com’. In this first request, you can leak sensitive data on an unencrypted connection. Without either of the above security controls implemented, a hacker can abuse this to steal session cookies and hijack your account.<h2 id=story-time>Story Time</h2><p>Scenario! A user is at home, browsing the internet. On their <strong><em>phone</em></strong>, the absolute animal. Anyway. Dear user decides to visit the Next website, to buy some wavy garms. They register to the website and fill out their details; full name, mothers’ maiden name, address, favourite colour, postcode – the works.<p><em>Note: www.next.co.uk is an arbitrary URL that we picked from a hat. No hard feelings. Don’t sue us.</em><p>Hmm! Does this site have any security in place? Our user is indifferent, but us hackers are a curious lot. Let’s look at the HTTP response we get after logging in (trimmed for brevity):<div class="language-http highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>302</span> <span class=ne>Moved Temporarily</span>
<span class=na>Content-Type</span><span class=p>:</span> <span class=s>text/html; charset=utf-8</span>
<span class=na>Location</span><span class=p>:</span> <span class=s>https://www.next.co.uk/secure/account/myaccount</span>
<span class=na>Content-Security-Policy</span><span class=p>:</span> <span class=s>frame-ancestors 'self' iguidewebapp.next-uk.next.loc/ end-duws02.next-uk.next.loc/ end-dpws02.next-uk.next.loc/ studio.mgmt.qa.test/ studio.mgmt.next-uk.next.loc/</span>
<span class=na>Set-Cookie</span><span class=p>:</span> <span class=s>Next-AP=accountEmail=[..]&amp;Version=[..]; expires=Tue, 08-Apr-2070 09:27:02 GMT; path=/; HttpOnly</span>
<span class=na>Set-Cookie</span><span class=p>:</span> <span class=s>NextSaleAuth=AccountNo=[..]&amp;Version=[..]&amp;AuthToken=[..]&amp;Timestamp=[..]&amp;SourceSite=Main&amp;ReadVIPSalePopUpModal=False; path=/; HttpOnly</span>
<span class=na>Set-Cookie</span><span class=p>:</span> <span class=s>bm_sv=[..]; Domain=.next.co.uk; Path=/; Max-Age=4523; HttpOnly</span>
<span class=s>[..]</span>
</code></pre></div></div><p>Now, there are couple things to point out about this response:<ul><li>three cookies have been set by the application; “Next-AP”, “NextSaleAuth”, and “bm_sv”<li>they’ve implemented the <code class=highlighter-rouge>HttpOnly</code> control on all cookies<li>they’re using a <code class=highlighter-rouge>Content-Security-Policy</code> header. Good stuff!</ul><p>However:<ul><li>the <code class=highlighter-rouge>Strict-Transport-Security</code> header is missing<li>the <code class=highlighter-rouge>Secure</code> flag has not been set on any of the cookies.</ul><p>Back to the story. Let’s say our user visits their local coffee shop. They order a super soy express macchiato, to drink in. Because, well..:
<a href=/assets/img/supersoy.png><img src=/assets/img/supersoy.png alt="yeah, that's definitely what he ordered" title="yeah, that's definitely what he ordered"></a><p>While at the coffee shop, our user connects to the free WiFi and decides to continue their shopping. The user enters www.next.co.uk into their browser.<p><strong style=text-align;text-align:center;width:100%;display:block>- SUDDEN CUT TO BLACK -</strong><h2 id=the-issue>The Issue</h2><p>Here is the problem. If the user types the address into their browsers’ address bar as above, their browser will send the first request to the site over HTTP instead of HTTPS. (<em>yes, there are exceptions, stop interrupting</em>.)<p>This request will include all the login cookies that the user has stored.<p>Ahem. <strong><em>This request will include all the login cookies that the user has stored.</em></strong><p>As the <code class=highlighter-rouge>Strict-Transport-Security</code> header hasn’t been set for the site, the browser will allow the request to be made over HTTP. In addition, as the site didn’t set the <code class=highlighter-rouge>Secure</code> flag on cookies, those login cookies will be sent over the unsecured connection.<p>Unbeknownst to the user, a hacker is sitting in a dark corner of the coffeeshop with his hoody on. Our hacker is connected to the same WiFi. He is intercepting all network traffic and looking at the data scroll by in big green letters, matrix-style.<p>When our poor user attempts to load www.next.co.uk on his phone, the phone sends a request to www.next.co.uk over HTTP. That request is captured by the hacker. Because that request is not sent over a secure channel (HTTPS), the hacker can easily read the contents of the request – including session information.<p>The following screenshot shows the full request captured by our friendly neighbourhood hacker (using tcpdump):
<a href=/assets/img/tcpdump_hsts.png><img src=/assets/img/tcpdump_hsts.png alt="tcpdump output" title="tcpdump output"></a><p>The hacker can now use this session information and authenticate to the application, impersonating the victim and gaining access to their private information.<h2 id=conclusions>Conclusions</h2><p>So, what is one to do? Some may argue that a user attempting to connect to their site over an unsecured connection is “<em>not my problem</em>”. This is missing the point. Existing protections are available and easy to implement.<p><a href=https://letsencrypt.org/>Let’s Encrypt</a>, a service which lets you generate SSL certificates for your websites, is <em>FREE</em>. And that’s a great price! Also, users don’t care if they’re at fault for a security breach, they will want <em>you</em> to fix it. It’s prudent to implement strong security controls to protect your brand’s reputation.<p>Web application security is a vast and complicated topic. Each aspect of application security is as important as the others. Use the tools you have available! On that note, there are other security flags you can apply to cookies – expect an article on the <code class=highlighter-rouge>SameSite</code> cookie flag soon.<p>For further reading, consult the amazing Mozilla Developer Network for information about how to correctly implement <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security>HSTS</a> and the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies>Secure</a> cookie flag.</p></article></section><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115180299-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag("js",new Date());gtag("config","UA-115180299-2");</script><footer><div class=header-links><a href=https://www.arcturussecurity.com/><h2 class=header-link>Corp Site</h2></a><a href=https://github.com/arcturussecurity><h2 class=header-link>GitHub</h2></a><a href=https://twitter.com/arcturussec><h2 class=header-link>Twitter</h2></a></div></footer></main>