<!doctype html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>WordPress DoS: Rediscovering an Unpatched 0-Day | Arcturus Labs</title><link rel=stylesheet href=/assets/normalise.css><link rel=stylesheet href=/assets/style.css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><main><header><h1>Arcturus Labs</h1><div class=header-links><a href=/><h2 class=header-link>Home</h2></a><a href=/archive.html><h2 class=header-link>Archive</h2></a><a href=/about.html><h2 class=header-link>About</h2></a></div></header><section id=main_content><article><aside class=articleheading><h1>WordPress DoS: Rediscovering an Unpatched 0-Day</h1><h3>Posted by <a href=mailto:rory@arcturus.net>Rory M</a> on Friday, December 20 2019</h3></aside><h2 id=background>Background</h2><p>As how all the most‚Ä¶ <em>inspired</em> storytelling begins, I was at work. I was working on a pretty routine website test for a client; a fascinatingly average WordPress setup.<p>During my perusal of the site I noticed that <a href=https://github.com/wpscanteam/wpscan>wpscan</a> can bruteforce WordPress logins using the <a href=https://codex.wordpress.org/XML-RPC_WordPress_API>XMLRPC API</a>. Trying it, I piped the requests through Burp (<em>which I <strong>definitely</strong> always remember to do for the audit trail haha</em> üëÄ) and found out that it performs just one auth attempt per API call. After some light digging through the XMLRPC documentation, I discovered <code class=highlighter-rouge>system.multicall</code>.<p>Oho! Anything starting with ‚Äúsystem‚Äù sounds naughty. I had a <em>eureka!</em> moment when I figured I could multicall the method wpscan uses to brute-force logins, which would let me bruteforce much faster..!<p>After spending a good hour developing a working proof-of-concept I <em>then</em> discovered that said multicall login bruteforce issue had been <a href=https://core.trac.wordpress.org/ticket/34336>discovered and patched</a> a long time ago. Great minds and all that. Anyway, this <code class=highlighter-rouge>system.multicall</code> method‚Ä¶ the potential to run any API callback thousands of times, from a single request? Who came up with this? It‚Äôs BEGGING for abuse.<p>I moved on to investigating other available API callbacks. One such contender, ripe for some multicall abuse, is our friend <code class=highlighter-rouge>pingback.ping</code>. An awful ‚Äúfeature‚Äù (<em>opinionated? me?</em>) that allows blogs to tell each other when‚Ä¶ uh‚Ä¶ users post on them? I don‚Äôt even know.
<a href=/assets/img/wpdos_who_cares_about_pingbacks.png><img src=/assets/img/wpdos_who_cares_about_pingbacks.png alt="who cares about pingbacks"></a> Who cares? Point is that you can call this API unauthenticated and <em><strong>that‚Äôs what matters</strong></em>.<p>Calling this pingback API causes the server to send an HTTP request to a server of your choice. So, what happens if we use <code class=highlighter-rouge>system.multicall</code> to batch 4000 pingbacks into a single request, then send it about 200 times..?<p><a href=/assets/img/wpdos_dead_nginx.png><img src=/assets/img/wpdos_dead_nginx.png alt="bad things" title="Bad things"></a> Bad things.<h2 id=root-cause>Root Cause</h2><p>This is the <em>BIG BRAIN</em> section. If you just wanna go and DoS some scrubs, the <a href=https://youtu.be/dQw4w9WgXcQ>code is here</a>.<p>So. Root cause. What‚Äôs happening is that on receiving a request containing a load of pingback requests, WordPress actually issues EVERY SINGLE ONE, the ABSOLUTE madlad. As you can imagine, this takes a rather long time. Suppose (generously) that a server can complete a full request in 1 second, issuing 2000 pingbacks will use up half an hour of server resources.<p>Now isn‚Äôt this what PHP‚Äôs <code class=highlighter-rouge>max_execution_time</code> directive is for, you ask? Well, yes! A configuration directive with the <em>sole purpose</em> of preventing long-running scripts consuming too many resources! <a href=https://www.php.net/manual/en/function.set-time-limit.php#refsect1-function.set-time-limit-notes>Or so you‚Äôd think</a>:<blockquote><p>time spent on activity that happens outside the execution of the script [..] is not included when determining the maximum time that the script has been running.</blockquote><p>On *nix, PHP doesn‚Äôt take into account time spent doing non-PHP things‚Ä¶ such as cURL requests. <em>bruh.</em> why even have the directive in the first place lmao.<p>Each request WordPress issues has a 10 second timeout and we can queue a BUNCH of them into a single API call. After we issue about 200 such batched calls the server will be too busy repeatedly using up socket descriptors to do anything else.<h2 id=oh-god-how-do-i-fix-it>OH GOD HOW DO I FIX IT?</h2><p>WordPress have a troubling history of <a href=https://core.trac.wordpress.org/ticket/35532>Not</a> <a href=https://core.trac.wordpress.org/ticket/47551>Giving</a> a <a href=https://core.trac.wordpress.org/ticket/36806>Shit</a>‚Ñ¢ about Denial-of-Service issues, so right on cue they rapidly WONTFIX‚Äôd this after we raised it with them:
<a href=/assets/img/wpdos_dont_care.png><img src=/assets/img/wpdos_dont_care.png alt="dont care" title="dont care"></a> Loss of availability isn‚Äôt a ‚Äúsevere issue‚Äù, after all.<p>I also tried to contact the PHP developers to argue that this is a language fault, but I got completely stonewalled.<p>But worry not, dear netizen! Arcturus are here to help. The hands-down best solution is to <s>uninstall WordPress</s> remove <code class=highlighter-rouge>xmlrpc.php</code>. Failing that, go through <em>every single post</em> on your site and disable pingbacks. Another option is to disable the <code class=highlighter-rouge>system.multicall</code> method with <a href=https://gist.github.com/roddux/7612285c3636260b1c156c40fe795f4e>this handy patch</a>. Y‚Äôall welcome ‚ô•<h2 id=pre-publish-update>Pre-publish Update</h2><p>Begrudgingly, I realised that as a <strong>PrOfeSSioNaL</strong>, I should try at least once more to report this responsibly to the community. I turned to the WordPress Bug Tracker (<em>what a horrorshow</em>) and started regurgitating this article. Before submitting I, on a whim, made a search for ‚Äòpingback multicall‚Äô. Turns out a similarly BIG BRAINed hacker found this exact issue! <a href=https://core.trac.wordpress.org/ticket/47856>4 months ago</a>. Lo and behold, THEY CLOSED IT AS NON-APPLICABLE AHHAHAHAHAHAH.<p>Despite this having been reported, this is still technically a zero-day because there‚Äôs no patch. A <em>4-month old</em> zero-day..! So yeah, the official line would appear to be ‚Äúscrew you, you‚Äôre on your own‚Äù. Apply the patch above and get busy moving the hell away from the platform.<p>On that happy note, proof of concept code is linked below. DON‚ÄôT DO AN ILLEGAL, iF YoU dO iT‚ÄôS NOt mY fAuLt. Merry Christmas!<p>PoC: <a href=https://github.com/roddux/wordpress-dos-poc>code here, no foolin</a><br>Hours slept: 2<br>Reported: 19th November<br>Caffeine consumed: 1250mg<br>Fixed: ‚Äò<em>DoS reports are out of the program scope.</em>‚Äô ¬Ø\_(„ÉÑ)_/¬Ø<br></p></article></section><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115180299-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag("js",new Date());gtag("config","UA-115180299-2");</script><footer><div class=header-links><a href=https://www.arcturussecurity.com/><h2 class=header-link>Corp Site</h2></a><a href=https://github.com/arcturussecurity><h2 class=header-link>GitHub</h2></a><a href=https://twitter.com/arcturussec><h2 class=header-link>Twitter</h2></a></div></footer></main>